<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="WaterEnergy">

	<resultMap id="usageInfo" class="egovframework.smartVillage.usr.waterEnergy.vo.UsageVo">
		<result property="recentRegDate" column="recent_reg_date" columnIndex="1"/>
		<result property="recentUsage" column="usage_difference" columnIndex="2"/>
		<result property="prevRegDate" column="prev_reg_date" columnIndex="3"/>
		<result property="prevUsage" column="prev_usage" columnIndex="4"/>
	</resultMap>
	
	<resultMap id="usageChartInfo" class="egovframework.smartVillage.usr.waterEnergy.vo.UsageChartVo">
		<result property="regMonth" column="reg_month" columnIndex="1"/>
		<result property="recentUsages" column="usage_difference" columnIndex="2"/>
		<result property="prevUsages" column="prev_usages" columnIndex="3"/>
	</resultMap>
		
	<select id="WaterEnergyDAO.selectWaterUsage" parameterClass="string" resultMap="usageInfo" >
		 SELECT
  			date_tab.recent_reg_date AS recent_reg_date,
  			date_tab.prev_reg_date AS prev_reg_date,
  			(SELECT MAX(CAST(AES_DECRYPT(unhex(water_usage), '3806380738083809') AS DOUBLE)) FROM tbl_house_energy_hist WHERE AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo# AND reg_date = date_tab.prev_reg_date  ) AS prev_usage,
  			ROUND(CAST(AES_DECRYPT(unhex(energy.water_usage), '3806380738083809') AS DOUBLE) - (SELECT MAX(CAST(AES_DECRYPT(unhex(water_usage), '3806380738083809') AS DOUBLE)) FROM tbl_house_energy_hist WHERE AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo# AND reg_date = date_tab.prev_month  ), 3) AS usage_difference 
		FROM tbl_house_energy_hist energy,
  (
    SELECT
      house_dong_ho,
      (
        SELECT MAX(reg_date)
        FROM tbl_house_energy_hist
        WHERE reg_date BETWEEN CONCAT(DATE_FORMAT(NOW(), '%Y%m'), '0000') 
          AND CONCAT(DATE_FORMAT(NOW(), '%Y%m'), '3124')
      ) AS 'recent_reg_date',
      (
        SELECT MAX(reg_date)
        FROM tbl_house_energy_hist
        WHERE STR_TO_DATE(reg_date,'%Y%m%d') BETWEEN LAST_DAY(NOW() - INTERVAL 13 MONTH) + INTERVAL 1 DAY 
          AND LAST_DAY(NOW() - INTERVAL 1 YEAR)
      ) AS 'prev_reg_date',
      (
        SELECT MAX(reg_date)
        FROM tbl_house_energy_hist
        WHERE STR_TO_DATE(reg_date,'%Y%m%d') = LAST_DAY(DATE_SUB(NOW(), INTERVAL 1 MONTH))
      ) AS 'prev_month'	
    FROM
      tbl_house_energy_hist
    WHERE
      AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo#
    GROUP BY
      house_dong_ho
  ) date_tab
WHERE
  reg_date = date_tab.recent_reg_date
  AND energy.house_dong_ho = date_tab.house_dong_ho
  AND real_time = (
    SELECT MAX(real_time)
    FROM tbl_house_energy_hist energy
    WHERE AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo#
  )
		
	</select>
	
	<select id="WaterEnergyDAO.selectElectricUsage" parameterClass="string" resultMap="usageInfo" >
		 SELECT
			date_tab.recent_reg_date AS recent_reg_date, 
			date_tab.prev_reg_date AS prev_reg_date, 
			ROUND((SELECT DISTINCT SUM(CAST(AES_DECRYPT(unhex(electricity_usage), '3806380738083809') AS DOUBLE)) FROM tbl_house_energy_hist WHERE AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo# AND reg_date LIKE CONCAT(SUBSTRING(prev_reg_date, 1, 6), '%')), 3) AS prev_usage,
			ROUND((SELECT DISTINCT SUM(CAST(AES_DECRYPT(unhex(electricity_usage), '3806380738083809') AS DOUBLE)) FROM tbl_house_energy_hist WHERE AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo# AND reg_date LIKE CONCAT(SUBSTRING(recent_reg_date, 1, 6), '%'))/3, 3) AS usage_difference
		FROM
			tbl_house_energy_hist energy,
			(
				SELECT 
					house_dong_ho,
					(SELECT MAX(reg_date) FROM tbl_house_energy_hist WHERE reg_date BETWEEN CONCAT(DATE_FORMAT(NOW(), '%Y%m'), '0000') AND CONCAT(DATE_FORMAT(NOW(), '%Y%m'), '3124')) AS 'recent_reg_date',
					(SELECT MAX(reg_date) FROM tbl_house_energy_hist WHERE STR_TO_DATE(reg_date,'%Y%m%d') BETWEEN LAST_DAY(NOW() - INTERVAL 13 MONTH)+ interval 1 DAY AND LAST_DAY(NOW() - INTERVAL 1 YEAR)) AS 'prev_reg_date'
				FROM 
					tbl_house_energy_hist
				WHERE
					AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo#
				GROUP BY
					house_dong_ho
			) date_tab
		WHERE
			reg_date = date_tab.recent_reg_date
			AND energy.house_dong_ho = date_tab.house_dong_ho
                        AND real_time = (SELECT MAX(real_time) FROM
			tbl_house_energy_hist energy 
                        WHERE AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo#) 
	</select>
	
	<select id="WaterEnergyDAO.selectHeatingUsage" parameterClass="string" resultMap="usageInfo" >
		 SELECT
			date_tab.recent_reg_date AS recent_reg_date, 
			date_tab.prev_reg_date AS prev_reg_date, 
			(SELECT MAX(CAST(AES_DECRYPT(unhex(heating_usage), '3806380738083809') AS DOUBLE)) FROM tbl_house_energy_hist WHERE AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo# AND reg_date = date_tab.prev_reg_date) AS prev_usage,
			ROUND(CAST(AES_DECRYPT(unhex(energy.heating_usage), '3806380738083809') AS DOUBLE) - (SELECT MAX(CAST(AES_DECRYPT(unhex(heating_usage), '3806380738083809') AS DOUBLE)) FROM tbl_house_energy_hist WHERE AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo# AND reg_date = date_tab.prev_month  ), 3) AS usage_difference 
		FROM tbl_house_energy_hist energy,
  (
    SELECT 
      house_dong_ho,
      (
        SELECT MAX(reg_date) 
        FROM tbl_house_energy_hist 
        WHERE reg_date BETWEEN CONCAT(DATE_FORMAT(NOW(), '%Y%m'), '0000') 
         AND CONCAT(DATE_FORMAT(NOW(), '%Y%m'), '3124')
      ) AS 'recent_reg_date',
      (
        SELECT MAX(reg_date) 
        FROM tbl_house_energy_hist 
        WHERE STR_TO_DATE(reg_date,'%Y%m%d') BETWEEN LAST_DAY(NOW() - INTERVAL 13 MONTH)+ interval 1 DAY AND LAST_DAY(NOW() - INTERVAL 1 YEAR)
      ) AS 'prev_reg_date',
      (
        SELECT MAX(reg_date) 
        FROM tbl_house_energy_hist WHERE STR_TO_DATE(reg_date,'%Y%m%d') = LAST_DAY(DATE_SUB(NOW(), INTERVAL 1 MONTH))
      ) AS 'prev_month'
      FROM 
      tbl_house_energy_hist
      WHERE
      AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo#
      GROUP BY
	house_dong_ho
     ) date_tab
		WHERE
			reg_date = date_tab.recent_reg_date
			AND energy.house_dong_ho = date_tab.house_dong_ho
                        AND real_time = (SELECT MAX(real_time) FROM
			tbl_house_energy_hist energy 
                        WHERE AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo#)  
	</select>
	
	<select id="WaterEnergyDAO.selectHotWaterUsage" parameterClass="string" resultMap="usageInfo" >
		 SELECT
			date_tab.recent_reg_date AS recent_reg_date, 
			date_tab.prev_reg_date AS prev_reg_date, 
			(SELECT MAX(CAST(AES_DECRYPT(unhex(hot_water_usage), '3806380738083809') AS DOUBLE)) FROM tbl_house_energy_hist WHERE AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo# AND reg_date = date_tab.prev_reg_date) AS prev_usage,
			ROUND(CAST(AES_DECRYPT(unhex(energy.hot_water_usage), '3806380738083809') AS DOUBLE) - (SELECT MAX(CAST(AES_DECRYPT(unhex(hot_water_usage), '3806380738083809') AS DOUBLE)) FROM tbl_house_energy_hist WHERE AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo# AND reg_date = date_tab.prev_month), 3) AS usage_difference 
		FROM tbl_house_energy_hist energy,
			(
			SELECT 
			 house_dong_ho,
			 (
                          SELECT MAX(reg_date) 
                          FROM tbl_house_energy_hist 
                          WHERE reg_date BETWEEN CONCAT(DATE_FORMAT(NOW(), '%Y%m'), '0000') 
                          AND CONCAT(DATE_FORMAT(NOW(), '%Y%m'), '3124')
                         ) AS 'recent_reg_date',
			(
                          SELECT MAX(reg_date) 
                          FROM tbl_house_energy_hist 
                          WHERE STR_TO_DATE(reg_date,'%Y%m%d') BETWEEN LAST_DAY(NOW() - INTERVAL 13 MONTH)+ interval 1 DAY 
                            AND LAST_DAY(NOW() - INTERVAL 1 YEAR)
                         ) AS 'prev_reg_date',
		        (
                          SELECT MAX(reg_date) 
                          FROM tbl_house_energy_hist 
                          WHERE STR_TO_DATE(reg_date,'%Y%m%d') = LAST_DAY(DATE_SUB(NOW(), INTERVAL 1 MONTH))
                          )AS 'prev_month'
		       FROM 
			tbl_house_energy_hist
		       WHERE
			AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo#
		       GROUP BY
			house_dong_ho
			) date_tab
		     WHERE
			reg_date = date_tab.recent_reg_date
			AND energy.house_dong_ho = date_tab.house_dong_ho
                        AND real_time = (
                        SELECT MAX(real_time) 
                        FROM tbl_house_energy_hist energy 
                        WHERE AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo#
                        ) 
	</select>		
	
	<select id="WaterEnergyDAO.selectWaterUsageChartData" parameterClass="string" resultMap="usageChartInfo">
  SELECT
    CONCAT(CAST(CAST(recent_usage.reg_month AS INTEGER) AS CHAR), '월') AS reg_month,
    prev_usage.water_usage AS prev_usages,
    ROUND(recent_usage.water_usage - (SELECT MAX(CAST(AES_DECRYPT(unhex(water_usage), '3806380738083809') AS DOUBLE)) FROM tbl_house_energy_hist WHERE AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo# AND reg_date = recent_usage.prev_month  ), 3) AS usage_difference 
  FROM
    (
      SELECT
        reg_date,
        substring(reg_date, 5, 2) AS reg_month,
        MAX(CAST(AES_DECRYPT(unhex(water_usage), '3806380738083809') AS DOUBLE)) AS water_usage,
        house_dong_ho,
        LAST_DAY(DATE_SUB(STR_TO_DATE(reg_date,'%Y%m%d'), INTERVAL 1 MONTH)) AS prev_month
      FROM
        tbl_house_energy_hist
      WHERE
        reg_date IN (
          SELECT
            MAX(reg_date) AS reg_date
          FROM
            tbl_house_energy_hist
          WHERE
            AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo#
            AND STR_TO_DATE(reg_date, '%Y%m') BETWEEN LAST_DAY(NOW() - INTERVAL 7 MONTH) + INTERVAL 1 DAY AND LAST_DAY(NOW())
          GROUP BY
            substring(reg_date, 1, 6)
        )
        AND AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo#
      GROUP BY
        reg_date
    ) recent_usage
    JOIN (
      SELECT
        reg_date,
        substring(reg_date, 5, 2) AS reg_month,
        MAX(CAST(AES_DECRYPT(unhex(water_usage), '3806380738083809') AS DOUBLE)) AS water_usage,
        house_dong_ho
      FROM
        tbl_house_energy_hist
      WHERE
        reg_date IN (
          SELECT
            MAX(reg_date) AS reg_date
          FROM
            tbl_house_energy_hist
          WHERE
            AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo#
            AND STR_TO_DATE(reg_date, '%Y%m') BETWEEN LAST_DAY(NOW() - INTERVAL 19 MONTH) + INTERVAL 1 DAY AND LAST_DAY(NOW() - INTERVAL 1 YEAR)
          GROUP BY
            substring(reg_date, 1, 6)
        )
        AND AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo#
      GROUP BY
        reg_date
    ) prev_usage ON recent_usage.reg_month = prev_usage.reg_month AND recent_usage.house_dong_ho = prev_usage.house_dong_ho
  ORDER BY
    recent_usage.reg_date

	</select>
	
	<select id="WaterEnergyDAO.selectElectricUsageChartData" parameterClass="string" resultMap="usageChartInfo" >
		SELECT
			CONCAT(CAST(CAST(recent_usage.reg_month AS INTEGER) AS CHAR), '월') AS reg_month,
			prev_usage.electricity_usage AS prev_usages,
                        ROUND((SELECT DISTINCT SUM(CAST(AES_DECRYPT(unhex(electricity_usage), '3806380738083809') AS DOUBLE)) FROM tbl_house_energy_hist WHERE AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo# AND reg_date LIKE CONCAT(SUBSTRING(recent_usage.reg_date, 1, 6), '%'))/3, 3) AS usage_difference 
		FROM
		(
		SELECT
		  reg_date, substring(reg_date, 5, 2) AS reg_month,
		  MAX(CAST(AES_DECRYPT(unhex(electricity_usage), '3806380738083809') AS DOUBLE)) AS electricity_usage,
		  house_dong_ho
		FROM tbl_house_energy_hist
		WHERE 
		  reg_date in (
		      SELECT
			max(reg_date) as reg_date
		      FROM 
			tbl_house_energy_hist 
		      WHERE 
			AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo# 
			AND STR_TO_DATE(reg_date,'%Y%m') BETWEEN LAST_DAY(NOW() - INTERVAL 7 MONTH) + INTERVAL 1 DAY AND LAST_DAY(NOW())
		      GROUP BY 
			substring(reg_date, 1, 6)
		)
		AND AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo# GROUP BY reg_date
		)recent_usage
		JOIN (
		  SELECT
		     reg_date, substring(reg_date, 5, 2) AS reg_month,
		     MAX(CAST(AES_DECRYPT(unhex(electricity_usage), '3806380738083809') AS DOUBLE)) AS electricity_usage,
		     house_dong_ho
		     FROM tbl_house_energy_hist
		     WHERE 
		      reg_date in (
			  SELECT
			   MAX(reg_date) AS reg_date
			  FROM 
			   tbl_house_energy_hist 
			  WHERE 
			   AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo# 
			   AND STR_TO_DATE(reg_date,'%Y%m') BETWEEN LAST_DAY(NOW() - INTERVAL 19 MONTH) + INTERVAL 1 DAY AND LAST_DAY(NOW() - INTERVAL 1 YEAR)
			  GROUP BY 
			   substring(reg_date, 1, 6)
		)
		AND AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo# GROUP BY reg_date
		)prev_usage ON recent_usage.reg_month = prev_usage.reg_month
			AND recent_usage.house_dong_ho = prev_usage.house_dong_ho
		ORDER BY recent_usage.reg_date
	</select>
	
	<select id="WaterEnergyDAO.selectHeatingUsageChartData" parameterClass="string" resultMap="usageChartInfo" >
		SELECT
			CONCAT(CAST(CAST(recent_usage.reg_month AS INTEGER) AS CHAR), '월') AS reg_month,
			prev_usage.heating_usage AS prev_usages,
			ROUND(recent_usage.heating_usage - (SELECT MAX(CAST(AES_DECRYPT(unhex(heating_usage), '3806380738083809') AS DOUBLE)) FROM tbl_house_energy_hist WHERE AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo# AND reg_date = recent_usage.prev_month  ), 3) AS usage_difference 
		FROM
		(
	          SELECT
		   reg_date, substring(reg_date, 5, 2) AS reg_month, 
		   MAX(CAST(AES_DECRYPT(unhex(heating_usage), '3806380738083809') AS DOUBLE)) AS heating_usage,
		   house_dong_ho,
		   LAST_DAY(DATE_SUB(STR_TO_DATE(reg_date,'%Y%m%d'), INTERVAL 1 MONTH)) AS prev_month
		  FROM tbl_house_energy_hist
		  WHERE 
		    reg_date IN (
		     SELECT
		       MAX(reg_date) AS reg_date
		     FROM 
		       tbl_house_energy_hist 
		     WHERE 
		       AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo# 
		       AND STR_TO_DATE(reg_date,'%Y%m') BETWEEN LAST_DAY(NOW() - INTERVAL 7 MONTH) + INTERVAL 1 DAY AND LAST_DAY(NOW())
		     GROUP BY 
		       substring(reg_date, 1, 6)
		)
		AND AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo# 
              GROUP BY 
                reg_date
	)recent_usage
	JOIN (
	  SELECT
	    reg_date, 
               substring(reg_date, 5, 2) AS reg_month,
	    MAX(CAST(AES_DECRYPT(unhex(heating_usage), '3806380738083809') AS DOUBLE)) AS heating_usage,
	    house_dong_ho
	  FROM 
            tbl_house_energy_hist
	  WHERE 
	    reg_date in (
	      SELECT
		MAX(reg_date) AS reg_date
		FROM 
		  tbl_house_energy_hist 
		WHERE 
		  AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo# 
		  AND STR_TO_DATE(reg_date,'%Y%m') BETWEEN LAST_DAY(NOW() - INTERVAL 19 MONTH) + INTERVAL 1 DAY AND LAST_DAY(NOW() - INTERVAL 1 YEAR)
		GROUP BY 
		  substring(reg_date, 1, 6)
	   )
	  AND AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo# 
          GROUP BY
            reg_date
	   )prev_usage ON recent_usage.reg_month = prev_usage.reg_month AND recent_usage.house_dong_ho = prev_usage.house_dong_ho
	ORDER BY 
          recent_usage.reg_date
	</select>
	
	<select id="WaterEnergyDAO.selectHotWaterUsageChartData" parameterClass="string" resultMap="usageChartInfo" >
		SELECT
			CONCAT(CAST(CAST(recent_usage.reg_month AS INTEGER) AS CHAR), '월') AS reg_month,
			prev_usage.hot_water_usage AS prev_usages,
			ROUND(recent_usage.hot_water_usage - (SELECT MAX(CAST(AES_DECRYPT(unhex(hot_water_usage), '3806380738083809') AS DOUBLE)) FROM tbl_house_energy_hist WHERE AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo# AND reg_date = recent_usage.prev_month  ), 3) AS usage_difference 
		FROM
		(
			SELECT
				reg_date, substring(reg_date, 5, 2) AS reg_month, 
				MAX(CAST(AES_DECRYPT(unhex(hot_water_usage), '3806380738083809') AS DOUBLE)) AS hot_water_usage,
				house_dong_ho,
				LAST_DAY(DATE_SUB(STR_TO_DATE(reg_date,'%Y%m%d'), INTERVAL 1 MONTH)) AS prev_month
			FROM tbl_house_energy_hist
			WHERE 
				reg_date in (
					SELECT
					      MAX(reg_date) AS reg_date
					FROM 
						tbl_house_energy_hist 
					WHERE 
						AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo# 
						AND STR_TO_DATE(reg_date,'%Y%m') BETWEEN LAST_DAY(NOW() - INTERVAL 7 MONTH) + INTERVAL 1 DAY AND LAST_DAY(NOW())
					GROUP BY 
						substring(reg_date, 1, 6)
				)
				AND AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo# 
               GROUP BY 
                   reg_date
		)recent_usage
		JOIN (
			SELECT
				reg_date, substring(reg_date, 5, 2) AS reg_month,
				MAX(CAST(AES_DECRYPT(unhex(hot_water_usage), '3806380738083809') AS DOUBLE)) AS hot_water_usage,
				house_dong_ho
			FROM tbl_house_energy_hist
			WHERE 
				reg_date in (
					SELECT
						MAX(reg_date) AS reg_date
					FROM 
						tbl_house_energy_hist 
					WHERE 
						AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo# 
						AND STR_TO_DATE(reg_date,'%Y%m') BETWEEN LAST_DAY(NOW() - INTERVAL 19 MONTH) + INTERVAL 1 DAY AND LAST_DAY(NOW() - INTERVAL 1 YEAR)
					GROUP BY 
						substring(reg_date, 1, 6)
				)
				AND AES_DECRYPT(unhex(house_dong_ho), '3806380738083809') = #houseDongHo# GROUP BY reg_date
		)prev_usage ON recent_usage.reg_month = prev_usage.reg_month AND recent_usage.house_dong_ho = prev_usage.house_dong_ho
		ORDER BY recent_usage.reg_date
	</select>
</sqlMap>